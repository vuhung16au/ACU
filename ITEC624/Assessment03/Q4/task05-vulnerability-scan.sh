#!/bin/bash

# Task 5: Vulnerability Assessment with NSE Scripts
# This script performs vulnerability detection using Nmap Scripting Engine

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

TASK_NAME="Task 5: Vulnerability Assessment with NSE Scripts"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "=================================================="
echo -e "${BLUE}${TASK_NAME}${NC}"
echo "=================================================="
echo "Timestamp: $TIMESTAMP"
echo ""

# Check if containers are running
echo "Checking container status..."
KALI_RUNNING=$(docker inspect -f '{{.State.Running}}' kali-linux 2>/dev/null)
META_RUNNING=$(docker inspect -f '{{.State.Running}}' metasploitable2 2>/dev/null)

if [ "$KALI_RUNNING" != "true" ]; then
    echo -e "${RED}Error: Kali Linux container is not running${NC}"
    echo "Please run ./setup.sh first"
    exit 1
fi

if [ "$META_RUNNING" != "true" ]; then
    echo -e "${RED}Error: Metasploitable2 container is not running${NC}"
    echo "Please run ./setup.sh first"
    exit 1
fi

echo -e "${GREEN}✓${NC} Both containers are running"
echo ""

# Get Metasploitable 2 IP address
META_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' metasploitable2)
echo "Target IP: $META_IP (Metasploitable2)"
echo ""

# Create temporary file for output
TEMP_OUTPUT=$(mktemp)

# Run the NSE vulnerability scan
echo "Running NSE vulnerability scan with default scripts..."
echo "This will take several minutes - scanning for vulnerabilities..."
COMMAND="nmap -sC -sV -T4 $META_IP"
echo "Command: $COMMAND"
echo ""

docker exec kali-linux $COMMAND > "$TEMP_OUTPUT" 2>&1
SCAN_RESULT=$?

if [ $SCAN_RESULT -ne 0 ]; then
    echo -e "${YELLOW}Warning: Scan completed with warnings${NC}"
    echo "Checking results..."
    echo ""
fi

# Display output
echo "Scan Output:"
echo "-----------------------------------"
cat "$TEMP_OUTPUT"
echo "-----------------------------------"
echo ""

# Parse and identify vulnerabilities
echo -e "${GREEN}Analyzing Vulnerabilities and Security Concerns...${NC}"
echo ""

# Count services detected
TOTAL_SERVICES=$(grep -c "^[0-9]*.*open" "$TEMP_OUTPUT")
echo "Total services analyzed: $TOTAL_SERVICES"
echo ""

# Look for common vulnerability indicators
echo "Identified Security Issues:"
echo "-----------------------------------"

# Initialize vulnerability counter
VULN_COUNT=0

# Check for common vulnerabilities in the output
if grep -qi "vulnerable\|VULNERABLE" "$TEMP_OUTPUT"; then
    echo -e "${RED}✗${NC} Explicit vulnerabilities detected:"
    grep -i "vulnerable\|VULNERABLE" "$TEMP_OUTPUT" | head -5
    VULN_COUNT=$((VULN_COUNT + $(grep -ci "vulnerable" "$TEMP_OUTPUT")))
    echo ""
fi

# Check for anonymous access
if grep -qi "anonymous" "$TEMP_OUTPUT"; then
    echo -e "${RED}✗${NC} Anonymous access detected:"
    grep -i "anonymous" "$TEMP_OUTPUT" | head -3
    VULN_COUNT=$((VULN_COUNT + 1))
    echo ""
fi

# Check for weak authentication
if grep -qi "password\|login\|auth" "$TEMP_OUTPUT"; then
    echo -e "${YELLOW}!${NC} Authentication-related findings:"
    grep -i "password\|login\|auth" "$TEMP_OUTPUT" | head -3
    echo ""
fi

# Check for outdated versions (common in Metasploitable)
if grep -qi "version\|backdoor\|exploit" "$TEMP_OUTPUT"; then
    echo -e "${YELLOW}!${NC} Version/exploit-related information:"
    grep -i "backdoor\|exploit" "$TEMP_OUTPUT" | head -3
    echo ""
fi

# Check for default credentials
if grep -qi "default" "$TEMP_OUTPUT"; then
    echo -e "${RED}✗${NC} Default configuration detected:"
    grep -i "default" "$TEMP_OUTPUT" | head -3
    VULN_COUNT=$((VULN_COUNT + 1))
    echo ""
fi

echo "-----------------------------------"
echo -e "${YELLOW}Total potential security issues found: $VULN_COUNT+${NC}"
echo ""

# Append to reports/commands.md
echo "Updating reports/commands.md..."
cat >> reports/commands.md << EOF

## ${TASK_NAME}

**Timestamp:** $TIMESTAMP

**Command:**
\`\`\`bash
$COMMAND
\`\`\`

**Purpose:** Use Nmap Scripting Engine (NSE) to run default vulnerability detection scripts against the target to identify security weaknesses.

**Flags Explanation:**
- \`-sC\`: Run default NSE scripts (equivalent to --script=default)
- \`-sV\`: Version detection (required for many vulnerability scripts)
- \`-T4\`: Aggressive timing for faster scanning
- Target: $META_IP

**NSE Scripts Run:** The default script set includes:
- Authentication bypass checks
- Default credential tests
- Known vulnerability detection
- Information disclosure checks
- Security misconfiguration identification

---

EOF

# Append to reports/output.md
echo "Updating reports/output.md..."
cat >> reports/output.md << EOF

## ${TASK_NAME}

**Timestamp:** $TIMESTAMP

**Command:** \`$COMMAND\`

**Raw Output:**
\`\`\`
$(cat "$TEMP_OUTPUT")
\`\`\`

---

EOF

# Extract detailed vulnerability information
VULNERABLE_SERVICES=$(grep -B 2 -A 5 -i "vulnerable\|anonymous\|default" "$TEMP_OUTPUT" | head -50)

# Append to reports/results.md
echo "Updating reports/results.md..."
cat >> reports/results.md << EOF

## ${TASK_NAME}

**Timestamp:** $TIMESTAMP

**Summary:**
- Target IP: $META_IP (Metasploitable2)
- Scan type: NSE vulnerability assessment with default scripts
- Total services analyzed: $TOTAL_SERVICES
- Potential vulnerabilities identified: $VULN_COUNT+

### Vulnerability Findings

**Critical Security Concerns Detected:**

\`\`\`
$VULNERABLE_SERVICES
\`\`\`

### Top Vulnerabilities Identified

Based on the NSE scan results, at least two significant security concerns were identified:

**1. Anonymous Access / Weak Authentication**
$(if grep -qi "anonymous" "$TEMP_OUTPUT"; then
    echo "- Services allowing anonymous access were detected"
    echo "- This allows unauthorized users to access resources"
    echo "- Affected services: "
    grep -i "anonymous" "$TEMP_OUTPUT" | head -2
else
    echo "- Authentication mechanisms should be reviewed"
fi)

**Security Impact:**
- Unauthorized access to sensitive data
- Potential for data exfiltration
- Lateral movement opportunity for attackers

**2. Outdated/Vulnerable Service Versions**
$(if grep -qi "vulnerable\|exploit\|backdoor" "$TEMP_OUTPUT"; then
    echo "- Vulnerable service versions detected"
    echo "- Known exploits may exist for these versions"
    grep -i "vulnerable\|exploit" "$TEMP_OUTPUT" | head -2
else
    echo "- Multiple outdated services detected that may have known vulnerabilities"
fi)

**Security Impact:**
- Known exploits can be used to compromise the system
- Privilege escalation opportunities
- Remote code execution potential
- Complete system compromise possible

### Additional Security Concerns

**Service Exposure:**
- Multiple network services are unnecessarily exposed
- Each service increases the attack surface
- Some services have default configurations

**Information Disclosure:**
- Service banners reveal detailed version information
- Helps attackers identify specific exploits
- Facilitates targeted attack planning

### Security Implications Summary

**Risk Level: HIGH**

The target system exhibits multiple critical vulnerabilities:

1. **Authentication Weaknesses:** Anonymous or weak authentication allows unauthorized access
2. **Vulnerable Software:** Outdated versions with known exploits
3. **Information Disclosure:** Detailed service information aids attackers
4. **Large Attack Surface:** Multiple exposed services increase risk
5. **Default Configurations:** Services running with insecure defaults

### Recommendations

**Immediate Actions:**
1. Disable anonymous access on all services
2. Update all services to latest secure versions
3. Remove or disable unnecessary network services
4. Implement strong authentication mechanisms
5. Configure service banners to minimize information disclosure

**Long-term Security Measures:**
1. Implement network segmentation and access controls
2. Deploy intrusion detection/prevention systems (IDS/IPS)
3. Regular vulnerability scanning and patch management
4. Security hardening following CIS benchmarks
5. Continuous monitoring and logging
6. Implement principle of least privilege
7. Regular security audits and penetration testing

**Defense in Depth:**
- Firewall rules to restrict service access
- VPN for remote access instead of direct exposure
- Multi-factor authentication where applicable
- Security Information and Event Management (SIEM)
- Regular security awareness training

### NSE Script Categories Used

The default scripts include checks for:
- **Auth:** Authentication and authorization issues
- **Broadcast:** Network broadcast information
- **Default:** Safe default scripts for common vulnerabilities
- **Discovery:** Service and system information gathering
- **Safe:** Scripts unlikely to crash or affect the target
- **Version:** Detailed version information gathering

---

EOF

# Cleanup
rm "$TEMP_OUTPUT"

echo -e "${GREEN}✓${NC} Task completed successfully"
echo -e "${GREEN}✓${NC} Vulnerabilities documented in reports/"
echo ""
echo -e "${YELLOW}Important:${NC} Review reports/results.md for detailed vulnerability analysis"
echo ""

